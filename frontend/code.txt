import os

# ================== CÃC Má»¤C Cáº¦N Bá» QUA ==================
IGNORE_DIRS = {
    ".git", ".github", ".vs", "bin", "obj", "tailieu",
    "bootstrap", "node_modules", "__pycache__"
}

IGNORE_FILES = {
    ".gitignore", ".gitattributes", "desktop.ini"
}

# ================== KIá»‚M TRA Bá» QUA ==================
def should_ignore_dir(dirname):
    return dirname.strip().lower() in IGNORE_DIRS

def should_ignore_file(filename):
    return filename.strip().lower() in IGNORE_FILES


# ================== Váº¼ CÃ‚Y THÆ¯ Má»¤C ==================
def draw_structure(root_path, prefix="", is_last=True, output_lines=None, level=0, max_depth=5):
    if output_lines is None:
        output_lines = []

    basename = os.path.basename(root_path.rstrip("\\/"))
    connector = "â””â”€â”€ " if is_last else "â”œâ”€â”€ "
    output_lines.append(f"{prefix}{connector}{basename}/")

    if level >= max_depth:
        return output_lines

    new_prefix = prefix + ("    " if is_last else "â”‚   ")

    try:
        entries = sorted(os.listdir(root_path))
    except (PermissionError, FileNotFoundError):
        return output_lines

    dirs = [e for e in entries if os.path.isdir(os.path.join(root_path, e))]
    files = [e for e in entries if os.path.isfile(os.path.join(root_path, e))]

    dirs = [d for d in dirs if not should_ignore_dir(d)]
    files = [f for f in files if not should_ignore_file(f)]

    for i, d in enumerate(dirs):
        sub_path = os.path.join(root_path, d)
        draw_structure(sub_path, new_prefix, i == len(dirs) - 1 and not files, output_lines, level + 1, max_depth)

    for i, f in enumerate(files):
        connector = "â””â”€â”€ " if i == len(files) - 1 else "â”œâ”€â”€ "
        output_lines.append(f"{new_prefix}{connector}{f}")

    return output_lines


def export_project_tree(project_path, save_dir):
    project_name = os.path.basename(os.path.normpath(project_path))
    output_file = os.path.join(save_dir, f"tree_{project_name}.txt")

    print(f"\nğŸŒ³ Äang táº¡o sÆ¡ Ä‘á»“ cÃ¢y: {project_name}")

    lines = [f"Solution '{project_name}'/\nâ”‚"]

    try:
        entries = sorted(os.listdir(project_path))
    except FileNotFoundError:
        print("âŒ ÄÆ°á»ng dáº«n khÃ´ng há»£p lá»‡!")
        return

    dirs = [
        d for d in entries
        if os.path.isdir(os.path.join(project_path, d)) and not should_ignore_dir(d)
    ]

    for i, d in enumerate(dirs):
        sub_lines = draw_structure(os.path.join(project_path, d), "", i == len(dirs) - 1)
        lines.extend(sub_lines)
        if i < len(dirs) - 1:
            lines.append("â”‚")

    with open(output_file, "w", encoding="utf-8") as f:
        f.write("\n".join(lines))

    print(f"âœ… ÄÃ£ lÆ°u file cÃ¢y táº¡i: {output_file}")


# ================== XUáº¤T MÃƒ NGUá»’N ==================
def read_file_safe(file_path):
    encodings = ["utf-8", "utf-8-sig", "latin1"]
    for enc in encodings:
        try:
            with open(file_path, "r", encoding=enc) as f:
                return f.read()
        except Exception:
            continue
    return None


def export_project_code(project_path, save_dir):
    project_name = os.path.basename(os.path.normpath(project_path))
    output_file = os.path.join(save_dir, f"code_{project_name}.txt")

    full_ext = [".cs", ".xaml", ".cshtml", ".py", ".js", ".html", ".json"]
    json_files = ["launchsettings.json", "appsettings.json"]

    print(f"\nğŸš€ Äang xuáº¥t mÃ£ nguá»“n: {project_name}")

    with open(output_file, "w", encoding="utf-8") as out:
        out.write(f"=== MÃƒ NGUá»’N Dá»° ÃN: {project_name} ===\n\n")

        for root, dirs, files in os.walk(project_path):

            # â— Bá» QUA Táº¤T Cáº¢ THÆ¯ Má»¤C TRONG IGNORE_DIRS (node_modules, .git, bin,â€¦)
            dirs[:] = [d for d in dirs if d.lower() not in IGNORE_DIRS]

            # â— Bá» QUA FILE TRONG IGNORE_FILES (desktop.ini,â€¦)
            files = [f for f in files if f.lower() not in IGNORE_FILES]

            for file in files:
                full_path = os.path.join(root, file)
                ext = os.path.splitext(file)[1].lower()

                try:
                    if (
                        ext in full_ext
                        or file.lower() in json_files
                        or file.lower().endswith(".xaml.cs")
                        or file.lower().endswith(".cshtml.cs")
                    ):
                        content = read_file_safe(full_path)
                        out.write(f"{full_path}\n")
                        out.write("=" * 80 + "\n")
                        out.write(content if content else "(KhÃ´ng Ä‘á»c Ä‘Æ°á»£c ná»™i dung)")
                        out.write("\n" + "=" * 80 + "\n\n")
                        print(f"ğŸ“„ Xuáº¥t ná»™i dung: {file}")
                    else:
                        out.write(f"{full_path}\n")
                        print(f"ğŸ“„ Ghi Ä‘Æ°á»ng dáº«n: {file}")

                except Exception as e:
                    print(f"âš ï¸ Lá»—i {file}: {e}")

    print(f"ğŸ‰ ÄÃ£ lÆ°u mÃ£ nguá»“n táº¡i: {output_file}")

    project_name = os.path.basename(os.path.normpath(project_path))
    output_file = os.path.join(save_dir, f"code_{project_name}.txt")

    # CÃ¡c loáº¡i file cáº§n Ä‘á»c ná»™i dung
    TEXT_EXT = [
        ".cs", ".xaml", ".cshtml", ".py", ".js", ".html", ".css",
        ".json", ".env", ".xml", ".txt"
    ]

    # File DB â†’ chá»‰ ghi Ä‘Æ°á»ng dáº«n (khÃ´ng má»Ÿ)
    DB_EXT = [".db", ".sqlite", ".sqlite3"]

    print(f"\nğŸš€ Äang xuáº¥t mÃ£ nguá»“n: {project_name}")

    with open(output_file, "w", encoding="utf-8") as out:
        out.write(f"=== MÃƒ NGUá»’N Dá»° ÃN: {project_name} ===\n\n")

        for root, dirs, files in os.walk(project_path):
            dirs[:] = [d for d in dirs if d.lower() not in ("bin", "obj")]

            for file in files:
                full_path = os.path.join(root, file)
                ext = os.path.splitext(file)[1].lower()

                try:
                    # â— File database â†’ KHÃ”NG Ä‘á»c ná»™i dung
                    if ext in DB_EXT:
                        out.write(f"{full_path}\n(KhÃ´ng xuáº¥t ná»™i dung file database)\n\n")
                        print(f"ğŸ—„ï¸ Bá» qua ná»™i dung DB: {file}")
                        continue

                    # â— File vÄƒn báº£n â†’ xuáº¥t ná»™i dung
                    if ext in TEXT_EXT or file.lower().endswith(".xaml.cs"):
                        content = read_file_safe(full_path)
                        out.write(f"{full_path}\n")
                        out.write("=" * 80 + "\n")
                        out.write(content if content else "(KhÃ´ng Ä‘á»c Ä‘Æ°á»£c ná»™i dung)")
                        out.write("\n" + "=" * 80 + "\n\n")
                        print(f"ğŸ“„ Xuáº¥t ná»™i dung: {file}")
                    else:
                        out.write(f"{full_path}\n")
                        print(f"ğŸ“„ Ghi Ä‘Æ°á»ng dáº«n: {file}")

                except Exception as e:
                    print(f"âš ï¸ Lá»—i {file}: {e}")

    print(f"ğŸ‰ ÄÃ£ lÆ°u mÃ£ nguá»“n táº¡i: {output_file}")


# ================== CHÆ¯Æ NG TRÃŒNH CHÃNH ==================
if __name__ == "__main__":
    print("=== TOOL: Váº¼ CÃ‚Y / XUáº¤T CODE Dá»° ÃN ===")

    save_dir = input("ğŸ’¾ Nháº­p thÆ° má»¥c lÆ°u file (Enter = thÆ° má»¥c hiá»‡n táº¡i): ").strip('" ')
    if not save_dir:
        save_dir = os.getcwd()
    elif not os.path.exists(save_dir):
        os.makedirs(save_dir)

    while True:
        print("\n--- CHá»ŒN CHá»¨C NÄ‚NG ---")
        print("1. Váº½ sÆ¡ Ä‘á»“ cÃ¢y thÆ° má»¥c")
        print("2. Xuáº¥t mÃ£ nguá»“n dá»± Ã¡n")
        print("3. Cháº¡y cáº£ hai")
        print("0. ThoÃ¡t")

        choice = input("ğŸ‘‰ Nháº­p lá»±a chá»n (0-3): ").strip()

        if choice == "0":
            print("ğŸ›‘ ThoÃ¡t chÆ°Æ¡ng trÃ¬nh.")
            break

        while True:
            project_path = input("\nğŸ“ DÃ¡n Ä‘Æ°á»ng dáº«n dá»± Ã¡n ('ok' Ä‘á»ƒ quay láº¡i menu): ").strip('" ')
            if project_path.lower() == "ok":
                break
            if not os.path.exists(project_path):
                print("âŒ ÄÆ°á»ng dáº«n khÃ´ng tá»“n táº¡i!")
                continue

            if choice == "1":
                export_project_tree(project_path, save_dir)

            elif choice == "2":
                export_project_code(project_path, save_dir)

            elif choice == "3":
                export_project_tree(project_path, save_dir)
                export_project_code(project_path, save_dir)

            print("\nğŸ¯ ÄÃ£ xong! Báº¡n cÃ³ thá»ƒ nháº­p dá»± Ã¡n khÃ¡c hoáº·c gÃµ 'ok' Ä‘á»ƒ thoÃ¡t.\n")
////////////////////////////////////////////////////////////
nÃ¢ng cáº¥p thÃªm code C# hoáº·c py Ä‘á»ƒ chá»n Ä‘á»ƒ lá»c ra cho  khá»i bá»‹ láº«n cÃ¡c thÆ° má»¥c phá»¥ 
Báº¡n Ä‘Ã£ nÃ³i:
.env váº«n Ä‘á»c
Báº¡n Ä‘Ã£ nÃ³i:
hoÃ n thiá»‡n code vá»›i tÃ­nh nÄƒng Ä‘Æ°á»£c nÃ¢ng cáº¥p
Báº¡n Ä‘Ã£ nÃ³i:
thÃªm js ná»¯a
Báº¡n Ä‘Ã£ nÃ³i:
ThÃªm PHP / Laravel

ThÃªm Java

ThÃªm Flutter (Dart)

Xuáº¥t ra ZIP

Xuáº¥t ra HTML cÃ³ highlight mÃ u

Giao diá»‡n GUI (Tkinter) Ä‘á»ƒ chá»n Ä‘Æ°á»ng dáº«n báº±ng nÃºt báº¥m

Báº¡n Ä‘Ã£ nÃ³i:
'ScrolledText' object is not callable
  File "E:\Tai Lieu Hoc Tap\CS 445 AM\xuatcode_va_xuatcay.py", line 465, in _run_export_thread
    self.log("=== Báº¯t Ä‘áº§u xuáº¥t ===", "info")
TypeError: 'ScrolledText' object is not callable

During handling of the above exception, another exception occurred:

  File "E:\Tai Lieu Hoc Tap\CS 445 AM\xuatcode_va_xuatcay.py", line 491, in _run_export_thread
    self.log(f"Lá»—i: {e}", "err")
TypeError: 'ScrolledText' object is not callable
Báº¡n Ä‘Ã£ nÃ³i:
ThÃªm nÃºt clear log?

Hiá»‡n thanh progress?

Táº¯t nÃºt khi Ä‘ang export?

Hiá»‡n popup bÃ¡o thÃ nh cÃ´ng?
ok 
Báº¡n Ä‘Ã£ nÃ³i:
âœ” Xuáº¥t ra HTML highlight mÃ u
âœ” Thanh tiáº¿n trÃ¬nh dáº¡ng %
âœ” Log mÃ u (info = xanh, warning = vÃ ng, error = Ä‘á»)
âœ” NÃºt Stop export
Báº¡n Ä‘Ã£ nÃ³i:
Hiá»ƒn thá»‹ tÃªn file Ä‘ang xá»­ lÃ½

Dark/light mode

Ghi log ra file

Animation khi export
Báº¡n Ä‘Ã£ nÃ³i:
hoÃ n thiá»‡n file code vá»›i nhá»¯ng tÃ­nh nÄƒng Ä‘Æ°á»£c nÃ¢ng cáº¥p
Báº¡n Ä‘Ã£ nÃ³i:
á»§a logic Ä‘Ã¢u?
Báº¡n Ä‘Ã£ nÃ³i:
viáº¿t Ä‘áº§y code vÃ  logic cÃ¹ng vá»›i nhá»¯ng nÃ¢ng cáº¥p má»›i